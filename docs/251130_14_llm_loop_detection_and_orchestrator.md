# LLM Loop Detection –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Orchestrator

**–î–∞—Ç–∞:** 2025-11-30
**–ü—Ä–æ–µ–∫—Ç:** VIDEO
**Epic:** VIDEO-28 (–£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –∏ –ø–æ–∏—Å–∫–∞)

---

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ Phase2 (VLLM –∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ) LLM –º–æ–∂–µ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞—Ç—å—Å—è –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–ª–æ–≤. –ü—Ä–∏–º–µ—Ä –∏–∑ –ª–æ–≥–∞:

```json
"keywords": ["–∞–π—Ç—ã–ø", "–∞–π—Ç—ã–ø", "–∞–π—Ç—ã–ø", "–∞–π—Ç—ã–ø", ... x500 —Ä–∞–∑]
```

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:
1. –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –¥–∞–Ω–Ω—ã–º –≤ –ë–î
2. –ü–æ—Ç–µ—Ä–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É
3. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ LLM

---

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –î–µ—Ç–µ–∫—Ü–∏—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –≤ phase2_vllm_analysis.py (—Å—Ç—Ä–æ–∫–∏ 165-230)

–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:
- `chinese_characters` - –∫–∏—Ç–∞–π—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –≤ –æ—Ç–≤–µ—Ç–µ
- `short_description` - –æ–ø–∏—Å–∞–Ω–∏–µ < 20 —Å–∏–º–≤–æ–ª–æ–≤
- `duplicate_description` - –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ–∂–¥—É —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏
- `empty_required_fields` - –ø—É—Å—Ç—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
- `invalid_confidence` - –Ω–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ confidence

**–î–æ–±–∞–≤–ª–µ–Ω–æ (–Ω–æ –Ω–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ):**
- `keyword_loop` - —Å–ª–æ–≤–æ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è 4+ —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ –≤ keywords
- `keyword_flood` - –º–µ–Ω–µ–µ 30% —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–ª–æ–≤ –≤ keywords
- `search_terms_loop` - –º–µ–Ω–µ–µ 30% —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–ª–æ–≤ –≤ search_terms

### –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `/mnt/e/projects/Quantum/Video_tagging/pipeline/model_orchestrator_v2.sh`
**–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤:** `/mnt/e/Projects/Quantum/Video_tagging_db/`

**–ü—Ä–æ–±–ª–µ–º–∞ —Å cron:**
- Cron –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –∏–∑ `/home/vano` (default cwd)
- –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –∏—â–µ—Ç —Å–∫—Ä–∏–ø—Ç—ã –º–æ–¥–µ–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ cwd
- –†–µ–∑—É–ª—å—Ç–∞—Ç: `Model script not found: qwen3_vl_32b.sh`

**–¢–µ–∫—É—â–∏–π crontab:**
```
*/1 * * * * /mnt/e/projects/Quantum/Video_tagging/pipeline/model_orchestrator_v2.sh cron
```

---

## –¢—Ä–µ–±—É–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –î–µ—Ç–µ–∫—Ü–∏—è –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è (phase2_vllm_analysis.py)

- [x] –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–µ–∫—Ü–∏—é `keyword_loop` (4+ –ø–æ–≤—Ç–æ—Ä–æ–≤ –ø–æ–¥—Ä—è–¥)
- [x] –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–µ–∫—Ü–∏—é `keyword_flood` (<30% —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö)
- [x] –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–µ–∫—Ü–∏—é `search_terms_loop`
- [ ] **–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ loop - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º LLM**
- [ ] –£–≤–µ–ª–∏—á–∏—Ç—å `quality_degradation_count` –ø–æ—Ä–æ–≥ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ (—Å–µ–π—á–∞—Å 3)

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º

- [ ] –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
- [ ] phase2 –¥–æ–ª–∂–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ñ–ª–∞–≥ `restart_vllm.flag`
- [ ] –§–ª–∞–≥ –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –≥–¥–µ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –µ–≥–æ –Ω–∞–π–¥–µ—Ç
- [ ] –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ - –¥–æ–∂–¥–∞—Ç—å—Å—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ API –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron

–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è:
1. **cd –≤ crontab:** `cd /path && ./orchestrator.sh cron`
2. **–°–∏–º–ª–∏–Ω–∫–∏ –≤ /home/vano** –Ω–∞ —Å–∫—Ä–∏–ø—Ç—ã –º–æ–¥–µ–ª–∏
3. **–ê–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—É—Ç–∏ –≤ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–µ** –≤–º–µ—Å—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö

### 4. –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ loop

```python
# –í detect_quality_degradation():
if "keyword_loop" in degradation_flags or "search_terms_loop" in degradation_flags:
    print("  üîÑ LLM loop detected, requesting restart...")
    self.restart_model(reason="llm_loop_detected")
    self.wait_for_model_restart(timeout=180)
    return True  # –°–∏–≥–Ω–∞–ª –¥–ª—è retry —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
```

---

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `phase2_vllm_analysis.py` | –õ–æ–≥–∏–∫–∞ retry –ø—Ä–∏ loop, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º |
| `model_orchestrator_v2.sh` | –ê–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—É—Ç–∏ –∏–ª–∏ cd –≤ –Ω–∞—á–∞–ª–µ |
| `qwen3_vl_32b.sh` | –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –ª—é–±–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ |
| crontab | –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∑–∞–ø—É—Å–∫–∞ |

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å Phase2 –∏ –¥–æ–∂–¥–∞—Ç—å—Å—è loop (–∏–ª–∏ —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–µ—Ç–µ–∫—Ü–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ–ª–∞–≥ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –º–µ—Å—Ç–µ
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ LLM –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Phase2 –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `phase2_vllm_analysis.py` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞
- `model_orchestrator_v2.sh` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—å—é
- `qwen3_vl_32b.sh` - —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ Qwen3 VL 32B
- `vllm_config.json` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è VLLM API
- `docs/AGENT_INSTRUCTIONS.md` - —á–µ–∫–ø–æ–∏–Ω—Ç—ã –∑–∞–¥–∞—á–∏

---

**–ü—É—Ç—å Windows:** E:\Projects\Quantum\Video_tagging_db\docs\251130_14_llm_loop_detection_and_orchestrator.md
